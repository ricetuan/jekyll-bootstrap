---
layout: post
title: "House ayalysis"
description: ""
category: 
tags: []
---
{% include JB/setup %}

##课题：用这些数据做一个租金模型的预测

##如何做：
大概想分一下四个步骤

- 基本数据分析：通过对数据进行简单分析和整理，来了解数据属性，总结重要的变量和异常的模式。
- 模型搭建与模型选择：利用上述数据进行分析并选择。反复1～2知道模型的精度达到预期标准。
- 自动化数据清洗：对上述数据进行自动化清理，自动整理出相关模型分析的数据
- 模型自动化API化：对已经建立的模型制作自动更新机制，并把结果用API输出

根据对结果精度的要求，可能每个步骤花的时间和方法会有些变化。考虑到1.课题也是对我工作方法的考察。2.这个步骤自身可能有改进的地方。我决定先把做一下先搭建起来这4个步骤的简单轮廓，得到一个基本的结果，然后在听取意见不断优化各个步骤。

<!--more-->

##基本数据分析
###基本数据整理（手动整理）：

- 去掉无用项：「データ種類」「物件種別」など
- 去掉意义不大的过疏项：「その他の月額費用」、「管理組合有無」
- 去掉重复项：「徒步分」和「徒步米数」，取「徒步分」
- 特异点过滤数据：去掉每平米成约价格超过1万的数据(e.g.成約賃料820000000)（10条，占全体约0.1%)
- 错误数据修正：退去時クリーニング 432000000 －－－》43200（房租时90000）


###単純集計：

*总体车站和房屋数量，高田马场和早稻田附近房子较多*

<img src="http://153.122.47.48/blog/picture/eki_count.jpg" width = "1200" height = "1000" />

不同的车站对于价钱稍稍有些影响，但是影响不大
<img src="http://153.122.47.48/blog/picture/eki_price.jpg" width = "1200" height = "1000" />

越新的房子，相对来说价钱会高一些
<img src="http://153.122.47.48/blog/picture/year_price.jpg" width = "1200" height = "1000" />

不同的房型，每平方米租金稍有变化。1room和1k的性价比最高
<img src="http://153.122.47.48/blog/picture/layout_price.jpg" width = "1200" height = "1000" />

到车站的距离对价格稍有影响，可能是由于在新宿站周围相对便利，所以影响不太大
<img src="http://153.122.47.48/blog/picture/walk_price.jpg" width = "1200" height = "1000" />

###数据意义分析：
从用户角度来说，租房的时候租房的成本＝每个月要付出钱＋初期要付出的钱。因此我做了以下的整理

- １ヶ月の料金 ＝成約賃料＋管理費＋公益費＋雑費
- 成約平方単価 ＝ １ヶ月の料金／平米数（每平方米一个月付多少钱）
- 初期コスト=礼金＋敷金+保険料+その他の料金など

###相关数据的选择过程
实际操作的中，变量选择上也可以做很大的文章。因为你如果能够把变量总结的很好的话，都不需要SVM等非线性模型，直接用线性模型就可以得到比较准确的结果。统计中有类似于「カイ二乗検定」等统计方法，由于只打算搭建一个基本的框架，因此基于我对不动产了解作出的判断，任性的决定了模型预测的パラメータ（囧）。
*以下是我选择的理由：可以跳过*

- 間取りについて：极端的情况可能导致房子的价钱有些变化，但是日本大部分房子偏向同治（間取り变化不是特别大）所以分析时忽略详细的間取り构造，只选取最基本的間取り
- 登陆年月日／变更年月日／成约年月日：实际的预测时无法知道这些数据，并且对投资来首没有特别大的帮助（舍弃）
- 现状，居住情况，交易形态等数据：这些数据时对房子出租时候的实际情况做的评估，对在投资预想的场景下并没有太多帮助（舍弃）
- バルコニー：962/7041 = 13% 有87％的房子没有阳台，这个数据和常识有点不符。可能是基本的小型的バルコニー没有被计入，如果有必要可以选择阳台额外的房间作为房子数据的补正，这次的简单过程决定忽略这昂数据
- 専用庭：只有9条数据，忽略，
- 駐車場：641/7041＝9.1%。但是实际用户有没有使用停车场并无法判断，也许可以做一个周边环境的参考指标
- 周边环境：16/7041＝0.2%。忽略
- 备考：2561/7041=36%。pet可，和住宅的属性可能是一个比较能参考的数据。然而实际如果在富士太郎网站上做预测时，可能不能取到非常详细的用户数据。所以这方面也暂时忽略
- 增改築：数据大小307/7041=4.3%。对多项增改筑数据进行合并，这里简单模型，所以忽略
- 内外装リフォーム是数据除了「築年数」里面唯一可以判断房间／外内部状态的数据，理论上会有参考价值。添加这条数据的是不动产商，并不能保证这个数据的客观性，有可能会引入误差。可以试着利用这个数据对房间的築年数做一个补正。

上述忽略的数据也可以全部可以整合起来，做一个权重比较小的补正

##模型搭建与模型选择：

###欠損値処理

- 处理手段很多，这里选择单纯的去掉空值。

###异常值处理：

- 对所有单个数据，利用统计的方法，假定数据服从正规分布，对超过3sigma的数据进行过滤。过疏数据在去除异常的时候，只选择非零数据
- 对于数据全体，利用one－class svm来去除异常值（当然也有其他的方法）。我把这个方法实现了，但使用的时候需要更详细的评定和参数设置，所以暂时在程序中把它注释掉。

###非线性数据的处理：

- 这里也可以做很多展开。比如地点数据可以自动根据网络API来转换成坐标数据，从而算出两个房子的距离。检索了一下，geocoding的API就可以实现这个功能（考虑到时间问题，先不做这个功能)

##模型的选择：
如果要提升模型的精度，这个步骤应该是最耗费时间的步骤，因为现在只打算搭起一个框架，所以只选取最最基本的方法回归来做一个范例。回归的话选择了基本的多重线性回归和非线性的SVM回归。之后可以根据结果进行优化，比如变量的定义和变量选择上。

做了线性回归和SVM回归之后，发现结果并不是很好…...囧。预测的值集中在最大范围的一个区间，可能房子间的属性上没有很好的变量去表示，因此需要在变量的选择和整理上需要在做进一步分析。

    
             predict           real  
    count  1373.000000    1373.000000
    mean   3609.260524    3829.980233
    std      10.180949    7505.422789
    min    3584.437441    1722.650000
    25%    3603.572206    3150.340000
    50%    3606.814907    3633.550000
    75%    3613.083228    4084.320000
    max    3663.195052  280541.000000
    

另外一个选择是利用新的方法（协同推荐）或者对反省变量选择的过程，对变量进行整理。个人觉得做一个协同推荐的结果会比较不错。
通过数据观察发现，基于过去数据的调整的模型应该是最准确的一个判断，没有过去数据的话：可以根据下面的数据来判断

- 房子的内在属性：层数，朝向，年数
- 房子的外在属性：周围的房价，经济景气与否

##关于自动化流程：
对于大量数据来说，上述数据整理和模型搭建全部人工来分析并不现实，需要有一套自动化的流程来整理数据。理想的结果当然是上面所有的结果都自动化，但是现阶段模型选择和变量选择上还是需要人来判断（深度学习也需不需要详细的变量选择）。虽然现在只有7000条数据，可以基本游人力来数据清洗与异常处理，但是可能数据量比较大，数据清洗与导入，数据的预处理和异常值处理都是需要自动化的。

当这个数据清理和异常处理自动化了之后，每当有新的数据的时候，就不需要重新做一次分析和整理，可以直接利用自动化流程导入新数据，提高模型的准确性。

###详细自动化内容

- 基本数据类型清理和导入csv_importer.py：读取csv，清理数据，存入数据库
    - 这里的清理指的是对数据表现形式的异常其清理，并不做逻辑清理
        - DO:比如日期型数据有些只有年和月(198807)，对于这类数据，自动补充称19880701
        - DO：居住层表示有部分数据写作6F，把它转换成6
        - 转码编码：nkf * -w > new_house_data
        - Not Do:房屋A月租金820000000元
    - 详细所有的参考csv_importer.py
    - [Github链接](https://github.com/ricetuan/fudousan/blob/master/csv_importer.py)
- 欠損値処理：
    - 去除空值
- 异常数据清理：
    - 单一变量异常判断3sigma
    - 整体的判断one-class svm(也可以用统计的方法如Lof之类)
    - [Github链接](https://github.com/ricetuan/fudousan/blob/master/chintai.py)
- 模型选择：
    - 线性回归和svm回归
    - TODO：基于协同过滤的计算
    - [Github链接](https://github.com/ricetuan/fudousan/blob/master/chintai.py)

##模型自动化API化
TODO。。。本来打算把这部分也做完，由于回国各种走亲戚和其它事情就没来得及把这部分写完。大概的想法就是：用基本的webservice（flask）或者serverless（aws lambda倾向于用这个！)的技术，把建好的模型API化。这个应该并不困难。
